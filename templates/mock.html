<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mock Interview</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div class="ai-container">
            <img id="aiAvatar" src="/static/avatar.png" class="ai-avatar" alt="AI Interviewer">
            <audio id="aiVoice" controls></audio>
            <h2 id="questionText">Welcome! Click "Next" to begin.</h2>
            <button class="next-btn" onclick="getNextQuestion()">Next</button>
        </div>

        <div class="user-section">
            <h2>Live Camera Analysis</h2>
            <video id="webcam" autoplay></video>
            <button class="record-btn" onclick="startRecording()">üé§ Start Answer</button>
        </div>

        <div id="popup" class="popup"></div>

        <div id="feedbackModal" class="feedback-popup" style="display:none;">
            <h2 class="feedback-title">Final Interview Report</h2>
            <p class="feedback-content" id="feedbackText">Processing feedback...</p>
            <button class="close-btn" onclick="closeReport()">Close</button>
        </div>
    </div>

    <script>
        let currentQuestionIndex = 0;
        let responses = [];

        const video = document.getElementById("webcam");
        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            video.srcObject = stream;
        }).catch(error => {
            console.error("Webcam error:", error);
        });

        function showPopup(message, isError = false) {
            let popup = document.getElementById("popup");
            popup.innerText = message;
            popup.style.display = "block";
            popup.style.backgroundColor = isError ? "#D32F2F" : "#1565C0";
            setTimeout(() => { popup.style.display = "none"; }, 2500);
        }

        function getNextQuestion() {
            axios.get(`/get_question/${currentQuestionIndex}`).then(response => {
                document.getElementById("questionText").innerText = response.data.question;
                document.getElementById("aiVoice").src = response.data.audio_url;
                currentQuestionIndex++;

                if (response.data.index === -1) {
                    document.querySelector(".next-btn").style.display = "none";
                    document.querySelector(".record-btn").style.display = "none";
                    setTimeout(() => { showReport(); }, 2000);
                }
            }).catch(error => {
                console.error("Next question error:", error);
            });
        }

        function startRecording() {
            showPopup("üé§ Recording Started...");
            audioChunks = [];
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = processRecording;
                setTimeout(() => { mediaRecorder.stop(); }, 7000);
            }).catch(error => {
                console.error("Microphone error:", error);
            });
        }

        async function processRecording() {
            showPopup("‚èπ Processing Response...");
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });

            let formData = new FormData();
            formData.append("audio", audioBlob, "response.wav");

            try {
                let response = await axios.post("/analyze_response", formData);
                if (response.data.error) {
                    showPopup("‚ö†Ô∏è Error processing response. Using default feedback.", true);
                    generateFakeFeedback();
                } else {
                    responses.push({
                        question: document.getElementById("questionText").innerText,
                        finalScore: response.data.final_score,
                        improvements: response.data.improvements
                    });
                }
            } catch (error) {
                console.error("Server Error:", error);
                showPopup("‚ö†Ô∏è Server error. Using default feedback.", true);
                generateFakeFeedback();
            }
        }

        function generateFakeFeedback() {
            responses.push({
                question: "Unknown (Recording Issue)",
                finalScore: 65,
                improvements: "Try speaking more clearly and confidently. Elaborate your points further."
            });
        }

        function showReport() {
            if (responses.length === 0) {
                document.getElementById("feedbackText").innerHTML = "<p>No responses recorded. Try again.</p>";
            } else {
                let feedbackContent = "<h2>Interview Summary</h2>";
                responses.forEach((resp, index) => {
                    feedbackContent += `
                        <div class="feedback-section">
                            <h3><b>Question ${index + 1}:</b> ${resp.question}</h3>
                            <p><b>Final Score:</b> ${resp.finalScore}/100</p>
                            <p><b>Improvements:</b> ${resp.improvements}</p>
                        </div>
                        <hr>
                    `;
                });
                document.getElementById("feedbackText").innerHTML = feedbackContent;
            }
            document.getElementById("feedbackModal").style.display = "block";
        }

        function closeReport() {
            document.getElementById("feedbackModal").style.display = "none";
        }
    </script>
</body>
</html>




